<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßü ZombieCoder Memory Dashboard</title>
  <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); margin-bottom: 10px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .controls {
            background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; gap: 15px; flex-wrap: wrap; align-items: center;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;
            font-size: 14px; transition: transform 0.2s ease;
        }
        .btn:hover { transform: scale(1.05); }
        .btn.secondary { background: #6c757d; }
        .btn.success { background: #28a745; }
        .btn.danger { background: #dc3545; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card {
            background: white; border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); }
        .card h3 { margin: 0 0 15px 0; color: #4a5568; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .metric { display: flex; justify-content: space-between; margin: 10px 0; padding: 8px 0; border-bottom: 1px solid #f7fafc; }
        .metric:last-child { border-bottom: none; }
        .metric-label { font-weight: 500; color: #2d3748; }
        .metric-value { font-weight: bold; color: #4a5568; }
        .conversation-item {
            background: #f8f9fa; border-radius: 8px; padding: 15px; margin: 10px 0; border-left: 4px solid #667eea;
        }
        .conversation-item.user { border-left-color: #28a745; }
        .conversation-item.assistant { border-left-color: #17a2b8; }
        .conversation-meta { font-size: 12px; color: #6c757d; margin-bottom: 5px; }
        .conversation-text { color: #2d3748; line-height: 1.5; }
        .log-entry {
            background: #f8f9fa; border-radius: 6px; padding: 10px; margin: 5px 0;
            font-family: 'Courier New', monospace; font-size: 12px; border-left: 3px solid #6c757d;
        }
        .log-entry.error { border-left-color: #dc3545; background: #f8d7da; }
        .log-entry.warning { border-left-color: #ffc107; background: #fff3cd; }
        .log-entry.info { border-left-color: #17a2b8; background: #d1ecf1; }
        .loading { text-align: center; color: #6c757d; font-style: italic; padding: 20px; }
        .refresh-indicator {
            position: fixed; top: 20px; right: 20px; background: rgba(255,255,255,0.9);
            padding: 10px 15px; border-radius: 20px; font-size: 12px; color: #6c757d;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .auto-refresh { display: flex; align-items: center; gap: 10px; }
        .auto-refresh input[type="checkbox"] { transform: scale(1.2); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .stat-item { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .stat-value { font-size: 24px; font-weight: bold; color: #667eea; }
        .stat-label { font-size: 12px; color: #6c757d; margin-top: 5px; }
  </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üßü ZombieCoder Memory Dashboard</h1>
            <p>Real-time Memory & Conversation Monitoring</p>
    </div>
        
        <div class="refresh-indicator">
            <div class="auto-refresh">
                <input type="checkbox" id="autoRefresh" checked>
                <label for="autoRefresh">Auto Refresh</label>
                <span id="lastUpdate">Never</span>
      </div>
    </div>

        <div class="controls">
            <button class="btn" onclick="refreshData()">üîÑ Refresh Now</button>
            <button class="btn secondary" onclick="downloadConversations()">üì• Download Conversations</button>
            <button class="btn success" onclick="quickWrite()">‚úèÔ∏è Quick Write</button>
            <button class="btn danger" onclick="clearMemory()">üóëÔ∏è Clear Memory</button>
            <div style="margin-left: auto; font-size: 12px; color: #6c757d;">
                <strong>Writer Commands:</strong><br>
                <code>python3 writer.py append --actor user --text "message"</code><br>
                <code>python3 writer.py stat --set route=local --set latency=120</code>
      </div>
    </div>

        <div class="dashboard" id="dashboard">
            <div class="loading">Loading dashboard data...</div>
    </div>
  </div>

  <script>
        let refreshInterval;
        let autoRefreshEnabled = true;
        
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            setupAutoRefresh();
        });
        
        function setupAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            checkbox.addEventListener('change', function() {
                autoRefreshEnabled = this.checked;
                if (autoRefreshEnabled) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
            
            if (autoRefreshEnabled) {
                startAutoRefresh();
            }
        }
        
        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(refreshData, 3000);
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        function refreshData() {
            Promise.all([
                fetch('memory/servers.json').then(r => r.json()).catch(() => ({})),
                fetch('memory/log.json').then(r => r.json()).catch(() => ({})),
                fetch('memory/conversations.json').then(r => r.json()).catch(() => ({})),
                fetch('memory/stats.json').then(r => r.json()).catch(() => ({}))
            ]).then(([servers, logs, conversations, stats]) => {
                updateDashboard({ servers, logs, conversations, stats });
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            }).catch(error => {
                console.error('Error fetching data:', error);
                document.getElementById('dashboard').innerHTML = `
                    <div class="card">
                        <h3>‚ùå Error Loading Data</h3>
                        <p>Make sure the memory files exist and the server is running.</p>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            });
        }
        
        function updateDashboard(data) {
            const { servers, logs, conversations, stats } = data;
            
            // Calculate local vs cloud percentage
            const total = (stats.local_responses || 0) + (stats.cloud_responses || 0);
            const localPercent = total > 0 ? Math.round(((stats.local_responses || 0) / total) * 100) : 0;
            const cloudPercent = total > 0 ? Math.round(((stats.cloud_responses || 0) / total) * 100) : 0;
            
            // Determine route status with better logic
            const currentRoute = stats.current_route || 'unknown';
            const isLocal = currentRoute === 'local' || (stats.local_responses || 0) > (stats.cloud_responses || 0);
            const routeColor = isLocal ? '#28a745' : '#dc3545';
            const routeIcon = isLocal ? 'üè†' : '‚òÅÔ∏è';
            
            // Latency status
            const latency = stats.avg_latency || 0;
            const latencyStatus = latency < 1000 ? 'excellent' : latency < 3000 ? 'good' : 'slow';
            const latencyColor = latency < 1000 ? '#28a745' : latency < 3000 ? '#ffc107' : '#dc3545';
            
            document.getElementById('dashboard').innerHTML = `
                <div class="card">
                    <h3>üîß Server Status</h3>
                    ${Object.entries(servers).map(([name, status]) => {
                        const serverStatus = status.status || 'unknown';
                        const statusColor = serverStatus === 'healthy' ? '#28a745' : serverStatus === 'unhealthy' ? '#ffc107' : '#dc3545';
                        const statusIcon = serverStatus === 'healthy' ? '‚úÖ' : serverStatus === 'unhealthy' ? '‚ö†Ô∏è' : '‚ùå';
                        return `
                            <div class="metric">
                                <span class="metric-label">${statusIcon} ${name.toUpperCase()}</span>
                                <span class="metric-value" style="color: ${statusColor}">${serverStatus.toUpperCase()}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div class="card">
                    <h3>üìä Real-time Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">${stats.total_requests || 0}</div>
                            <div class="stat-label">Total Requests</div>
                        </div>
                        <div class="stat-item" style="background: ${isLocal ? '#d4edda' : '#f8d7da'}; border: 2px solid ${isLocal ? '#28a745' : '#dc3545'};">
                            <div class="stat-value" style="color: ${isLocal ? '#28a745' : '#dc3545'}">${stats.local_responses || 0}</div>
                            <div class="stat-label">üè† Local Responses</div>
                        </div>
                        <div class="stat-item" style="background: ${!isLocal ? '#d4edda' : '#f8d7da'}; border: 2px solid ${!isLocal ? '#28a745' : '#dc3545'};">
                            <div class="stat-value" style="color: ${!isLocal ? '#28a745' : '#dc3545'}">${stats.cloud_responses || 0}</div>
                            <div class="stat-label">‚òÅÔ∏è Cloud Responses</div>
                        </div>
                        <div class="stat-item" style="background: ${latency < 1000 ? '#d4edda' : latency < 3000 ? '#fff3cd' : '#f8d7da'}; border: 2px solid ${latencyColor};">
                            <div class="stat-value" style="color: ${latencyColor}">${latency}ms</div>
                            <div class="stat-label">‚ö° Avg Latency</div>
                        </div>
                    </div>
                    
                    <div class="metric">
                        <span class="metric-label">üéØ Current Route:</span>
                        <span class="metric-value" style="color: ${routeColor}; font-size: 18px;">
                            ${routeIcon} ${isLocal ? 'LOCAL' : 'CLOUD'}
                        </span>
                    </div>
                    
                    <div class="metric">
                        <span class="metric-label">üìà Local Usage:</span>
                        <span class="metric-value" style="color: ${isLocal ? '#28a745' : '#dc3545'}">
                            ${localPercent}% Local, ${cloudPercent}% Cloud
                        </span>
                    </div>
                    
                    <div class="metric">
                        <span class="metric-label">‚ö° Latency Status:</span>
                        <span class="metric-value" style="color: ${latencyColor}">
                            ${latencyStatus.toUpperCase()} (${latency}ms)
                        </span>
                    </div>
                </div>
                
                <div class="card">
                    <h3>üí¨ Recent Conversations</h3>
                    ${(conversations.messages || []).slice(-5).map(msg => {
                        const isAssistant = msg.actor === 'assistant';
                        const isLocalResponse = isAssistant && msg.text.includes('local') || msg.text.includes('Ollama') || msg.text.includes('‡¶≤‡ßã‡¶ï‡¶æ‡¶≤');
                        const borderColor = isAssistant ? (isLocalResponse ? '#28a745' : '#17a2b8') : '#28a745';
                        const bgColor = isAssistant ? (isLocalResponse ? '#d4edda' : '#d1ecf1') : '#d4edda';
                        const icon = isAssistant ? (isLocalResponse ? 'üè†' : '‚òÅÔ∏è') : 'üë§';
                        
                        return `
                            <div class="conversation-item ${msg.actor}" style="border-left-color: ${borderColor}; background: ${bgColor};">
                                <div class="conversation-meta">
                                    ${icon} ${msg.actor.toUpperCase()} ‚Ä¢ ${new Date(msg.timestamp).toLocaleString()}
                                    ${isAssistant ? `<span style="float: right; font-size: 10px; color: ${isLocalResponse ? '#28a745' : '#17a2b8'};">${isLocalResponse ? 'LOCAL' : 'CLOUD'}</span>` : ''}
                                </div>
                                <div class="conversation-text">${msg.text}</div>
                            </div>
                        `;
                    }).join('')}
                    ${(conversations.messages || []).length === 0 ? '<p style="color: #6c757d; font-style: italic;">No conversations yet</p>' : ''}
                </div>
                
                <div class="card">
                    <h3>üìù Recent Logs</h3>
                    ${(logs.entries || []).slice(-10).map(log => `
                        <div class="log-entry ${log.level}">
                            <strong>[${log.timestamp}]</strong> ${log.message}
                        </div>
                    `).join('')}
                    ${(logs.entries || []).length === 0 ? '<p style="color: #6c757d; font-style: italic;">No logs yet</p>' : ''}
                </div>
            `;
        }
        
        function downloadConversations() {
            fetch('memory/conversations.json')
                .then(r => r.json())
                .then(data => {
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `conversations_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                })
                .catch(error => alert('Error downloading conversations: ' + error.message));
        }
        
        function quickWrite() {
            const actor = prompt('Actor (user/assistant):', 'user');
            const text = prompt('Message text:');
            
            if (actor && text) {
                fetch('memory/write', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ actor, text })
                })
                .then(() => {
                    alert('Message added successfully!');
                    refreshData();
                })
                .catch(error => alert('Error adding message: ' + error.message));
            }
        }
        
        function clearMemory() {
            if (confirm('Are you sure you want to clear all memory data?')) {
                fetch('memory/clear', { method: 'POST' })
                .then(() => {
                    alert('Memory cleared successfully!');
                    refreshData();
                })
                .catch(error => alert('Error clearing memory: ' + error.message));
            }
        }
    </script>
</body>
</html>
</html>